--- dokuwiki-2012-07-16/inc/html.php~	2012-07-16 11:47:58.000000000 +0300
+++ dokuwiki-2012-07-16/inc/html.php	2012-07-16 11:53:24.640163788 +0300
@@ -1086,9 +1086,13 @@
     // given as rev and rev2 parameters, with rev2 being optional. Or in an
     // array in rev2.
     $rev1 = $REV;
-
     $rev2 = $INPUT->ref('rev2');
-    if(is_array($rev2)){
+
+    // handle $r1 + $r2, see DW #1821
+    if ($INPUT->has('r1') && $INPUT->has('r2')) {
+        $rev1 = $INPUT->int('r1');
+        $rev2 = $INPUT->int('r2');
+    } elseif(is_array($rev2)){
         $rev1 = (int) $rev2[0];
         $rev2 = (int) $rev2[1];
 
--- dokuwiki-20110329/inc/html.php~	2011-03-29 09:20:42.000000000 +0300
+++ dokuwiki-20110329/inc/html.php	2011-03-29 09:21:51.507042136 +0300
@@ -1030,8 +1030,8 @@
 
         $diffurl = wl($ID, array(
                         'do'       => 'diff',
-                        'rev2[0]'  => $l_rev,
-                        'rev2[1]'  => $r_rev,
+                        'r1'       => $l_rev,
+                        'r2'       => $r_rev,
                         'difftype' => $type,
                       ));
         ptln('<br /><a class="wikilink1" href="'.$diffurl.'">'.$lang['difflink'].'</a>');
--- dokuwiki-2012-07-16/inc/common.php~	2012-07-16 11:55:03.000000000 +0300
+++ dokuwiki-2012-07-16/inc/common.php	2012-07-16 11:58:26.626127713 +0300
@@ -1178,6 +1178,8 @@
     } elseif($rev) {
         $subject         = $lang['mail_changed'].' '.$id;
         $trep['OLDPAGE'] = wl($id, "rev=$rev", true, '&');
+        $rev2            = $INFO['meta']['date']['modified'];
+        $trep['DIFFPAGE']= wl($id,"do=diff&r1=$rev&r2=$rev2",true,'&');
         $df              = new Diff(explode("\n", rawWiki($id, $rev)),
                                     explode("\n", rawWiki($id)));
         $dformat         = new UnifiedDiffFormatter();
@@ -1191,6 +1193,7 @@
     } else {
         $subject         = $lang['mail_newpage'].' '.$id;
         $trep['OLDPAGE'] = '---';
+        $trep['DIFFPAGE']= '---';
         $tdiff           = rawWiki($id);
         $hdiff           = nl2br(hsc($tdiff));
     }
